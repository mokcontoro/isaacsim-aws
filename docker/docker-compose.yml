services:
  isaac-sim:
    build:
      context: ./isaac-sim
      dockerfile: Dockerfile
    container_name: isaac-sim
    runtime: nvidia
    network_mode: host
    environment:
      - ACCEPT_EULA=Y
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - ROS_DOMAIN_ID=0
      - PUBLIC_IP=${PUBLIC_IP:-127.0.0.1}
    volumes:
      - isaac-cache:/isaac-sim/.cache
      - isaac-computecache:/isaac-sim/.nv/ComputeCache
      - isaac-data:/isaac-sim/.local/share/ov/data
      - isaac-logs:/isaac-sim/.nvidia-omniverse/logs
      - isaac-config:/isaac-sim/.nvidia-omniverse/config
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  ros2:
    build:
      context: ./ros2
      dockerfile: Dockerfile
    container_name: ros2
    network_mode: host
    ipc: host
    environment:
      - ROS_DOMAIN_ID=0
    volumes:
      - ./ros2/launch:/ros2_ws/launch:ro
    command: ros2 launch /ros2_ws/launch/bringup.launch.py
    depends_on:
      - isaac-sim

  nginx:
    image: nginx:alpine
    container_name: nginx
    network_mode: host
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - frontend-dist:/usr/share/nginx/html:ro
    depends_on:
      - ros2
      - frontend-build

  frontend-build:
    image: node:20-alpine
    container_name: frontend-build
    volumes:
      - ../frontend:/src:ro
      - frontend-dist:/output
    command: sh -c "cp -r /src /app && cd /app && npm ci && npm run build && cp -r dist/* /output/"

volumes:
  frontend-dist:
  isaac-cache:
  isaac-computecache:
  isaac-data:
  isaac-logs:
  isaac-config:
