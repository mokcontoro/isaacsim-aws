services:
  isaac-sim:
    build:
      context: ./isaac-sim
      dockerfile: Dockerfile
    container_name: isaac-sim
    runtime: nvidia
    environment:
      - ACCEPT_EULA=Y
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      # ROS2 domain ID (must match ros2 container)
      - ROS_DOMAIN_ID=0
    networks:
      - rosnet
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  ros2:
    build:
      context: ./ros2
      dockerfile: Dockerfile
    container_name: ros2
    environment:
      - ROS_DOMAIN_ID=0
    volumes:
      - ./ros2/launch:/ros2_ws/launch:ro
    command: ros2 launch /ros2_ws/launch/bringup.launch.py
    networks:
      - rosnet
    depends_on:
      - isaac-sim

  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - frontend-dist:/usr/share/nginx/html:ro
    networks:
      - rosnet
    depends_on:
      - ros2
      - frontend-build

  frontend-build:
    image: node:20-alpine
    container_name: frontend-build
    volumes:
      - ../frontend:/src:ro
      - frontend-dist:/output
    command: sh -c "cp -r /src /app && cd /app && npm ci && npm run build && cp -r dist/* /output/"

volumes:
  frontend-dist:

networks:
  rosnet:
    driver: bridge
